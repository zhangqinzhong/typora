# 3 数据查询方案

查询发起过逆向且使用礼券的经代销订单，导出表格

SELECT * FROM reverse_order_line WHERE trade_order_id IN (

SELECT transaction_id FROM `cz_promotion`.`buyer_resource_event_record` WHERE event_type = 30 and 

channel_code = 'default' and feature LIKE '%cashPoolCoupon530%');

过滤掉换货、补寄的逆向单 reverse_type = 4、6

过滤掉已关闭的逆向单 reverse_status = 4

筛选出 购买数量 不等于 退款数量 的订单 buy_quantity != refund_quantity（这里面包含多次发起售后的订单，这些订单的数量可能也退完了）

从上一步筛选出的订单中，过滤掉 退款数量 等于 最大可退数量 的订单 refund_quantity != remaining_quantity

·

1. 过滤掉换货、补寄的逆向单 reverse_type = 4、6

2. 过滤掉已关闭的逆向单 reverse_status = 4

3. 根据子订单ID分组，遍历分组后的map，如果发现子订单有退完的情况也就是buy_quantity = refund_quantity那么存放到一个临时变量（checkSet）中。

4. 再次遍历分组的map。如果checkSet中存在，则排除掉。

5. 取子订单中 remaining_quantity的最大值。和refund_quantity的累加结果做比较

6. 筛选出 refund_quantity != remaining_quantity