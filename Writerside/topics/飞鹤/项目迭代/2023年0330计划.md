### 三方售后单优化改动点：

* oms售后单列表查询
* rainbow售后单列表查询
* rainbow解析售后单 同步中台失败的异常信息 然后存入数据库
* rainbow新增定时任务 定时重试
* rainbow insert oms_reverse表时 需要保证 gmt_create字段不为null
* acm配置
* 定时任务配置
* 数据库新增字段



### 三方订单批量发起售后导致的BUG：

* rainbow修复BUG
* 抖音和非抖音2个项目都要改动



### 易宝ACM不生效BUG

* tb 修复BUG



#### 330需求汇总：

* 三方售后单优化
* BUG修复
* APIfox 填写
* 商品域学习



售后单优化：

产品：郑继诚

测试：李泽南



售后单列表：

纪元：retailforce_oms_pro，origin_reverse_select_page

oms：com.alibaba.oms.portal.api.trade.OriginReverseService#selectPage

rainbow：com.alibaba.rainbow.openapi.trade.OriginReverseApiService#selectPage

rainbow查询售后单列表逻辑关键信息：

查询oms_order_record表获取：

查询条件为：

```mysql
orderId = oms_order表id and operate_type in (3,4,5,6) 
```

operate_type 枚举：

```java
public enum OperateTypeEnum {
    UNDEFINED(-1,"未知操作"),
    CREATE_ABILITY_ORDER(0,"创建中台订单"),
    RECEIVE_GOODS(1,"确认收货"),
    MODIFY_DELIVERY_ADDRESS(2,"修改收货地址"),
    APPLY_REVERSE_SUBMIT(3,"提交售后单"),
    REFUND_CLOSED(4,"退款关闭"),
    REFUND_SUCCESS(5,"退款成功"),
    REFUND_REFUSE(6,"卖家退款拒绝"),
    DATA_UPDATE(7,"数据割接回填中台数据"),
    REVERSE_DATA_UPDATE(8,"售后单数据回填中台数据"),
    ;
}
```

oms查询售后单列表逻辑关键信息：

* //syncVersion 不等于执行失败的，都需要隐藏按钮 通过返回给前端的布尔类型isRetryHidden字段控制。true为隐藏

* 执行状态通过syncVersionLabel字段控制，syncVersionLabel字段逻辑为：

* //通过判断syncVersion，如果syncVersion = IS_FAIL 那么就获取oms_order_record表最新的一条数据显示tips给oms端。

  ```java
  public static TextLabel getSyncVersionLabel(int syncVersion, List<OrderRecordResponse> orderRecordResponseList,
                                                  String notSysPay) {
          String text;
          String color;
          String tips = null;
    			//syncVersion是售后表的syncVersion
          switch (syncVersion) {
              case IS_SYS:
                  text = "执行成功";
                  color = "success";
                  break;
              case IS_FAIL:
                  text = "执行失败";
                  color = "error";
                  tips = OriginOrderBusinessService.getTips(orderRecordResponseList);
                  break;
              case IS_NOT_SYS:
                  text = "等待执行";
                  color = "middle";
                  break;
              case NOT_SYS_PAY:
                  text = "无法执行";
                  color = "cancel";
                  tips = notSysPay;
                  break;
              case IS_DELAY_SYS:
                  text = "延迟执行";
                  color = "middle";
                  break;
              default:
                  text = "稍后处理";
                  color = "warning";
          }
          return TextLabel.getLabel(text, color, tips);
      }
  
  private static String getTips(List<OrderRecordResponse> orderRecordResponseList) {
          if (CollectionUtils.isEmpty(orderRecordResponseList)) {
              return StringUtils.EMPTY;
          }
          Integer executeResult = ExecuteResultEnum.EXECUTE_FAIL.getCode();
          for (OrderRecordResponse recordResponse : orderRecordResponseList) {
              if (executeResult.equals(recordResponse.getExecuteResult())) {
                  // 取出操作记录中第一条执行失败的提示语;操作记录列表是修改时间降序的，所以第一条就是最新的
                  return recordResponse.getDisplayMsg();
              }
          }
          return StringUtils.EMPTY;
      }
  ```
  
  ```mysql
  SELECT
  	* 
  FROM
  	oms_order_record 
  WHERE
  	operate_type IN ( 3, 4, 5, 6 ) 
  GROUP BY
  	display_msg 
  ORDER BY
  	gmt_create DESC 
  	LIMIT 1000
  ```
  



```json
{
    "result": [
        {
          	"handle_type":"无需人工处理",       
          	"business_type_error":"售后完成",
          	"display_error_content":"退款完成，无需售后",
          	"error_code":"reverse_011",
            "item": {
                "subTitle": "规格:1;",
                "imageUrl": "https://p6-aio.ecombdimg.com/obj/ecom-shop-material/ALSUvYM_m_92f054916dbed3af6228b5e5ef689b40_sx_868620_www600-600",
                "title": "【测试商品勿拍】【测试勿拍】海洋之心足银手链"
            },
            "gmtModified": "2023-03-07 09:42:14",
            "refundCount": "1",
            "originStoreName": "抖店开放平台测试专用店",
            "originReverseId": "7207613686167454009",
            "afterRefundStatusDesc": "待审核",
            "afterRefundStatus": 1,
            "retryHidden": true,
            "currencyPrice": "￥0.01",
            "syncVersionLabel": {
                "text": "等待执行",
                "type": "middle"
            },
            "id": "106070",
            "originOrderId": "5042524258472775597"
        }
    ],
    "ext": {},
    "total": 105027,
    "validateErrors": {},
    "success": true,
    "header": {
        "date": "2023-03-07 09:50:11",
        "traceId": "eaac11b53516781538108755346d6078",
        "rpcId": "0.2"
    },
    "platformFeatures": {},
    "businessFeatures": {}
}
```

 oms_reverse表新增字段：

1. 处理类型：handle_type   varchar类型

   无需人工处理：un_manual_process
   需人工处理：manual_process
   定时处理：timed_process

2. 报错分类 business_type_error   varchar类型

   创单：order_create
   地址：order_address
   会员异常：member_error
   履约异常：delivery_error
   确认收货：confirm_goods
   商品：item
   售后完成：reverse_finish
   系统异常：system_error
   已发货：already_shipped
   营销：marketing
   其他：other

3. 前端展示报错内容 display_error_content  varchar类型

   售后单列表展示内容：
   退款完成，无需售后
   订单已发货，请手动发起售后单
   退款完成，无需售后
   发货单撤回失败，请撤回发货单后重试
   订单已发货，请手动发起售后单
   请勿重复提交，请刷新页面

4. 错误码 error_code varchar类型





![image-20230309143118572](image-20230309143118572.png)



目前rainbow中用到order_record 表的4个地方。

其中，DyBaseService 和 BaseService都是查询接口。

所以实际可以insert order_record表的只有2个地方。

抖音项目中一个。订单项目中一个。



抖音：

com.alibaba.rainbow.core.service.trade.douyin.business.action.DyOrderRecordAction

订单：

com.alibaba.rainbow.core.service.trade.business.action.OrderRecordAction

```mysql
CREATE TABLE `oms_reverse` (
	`id` bigint(20) NOT NULL AUTO_INCREMENT,
	`origin_reverse_id` varchar(45) DEFAULT NULL COMMENT '外部售后单号',
	`outer_reverse_id` varchar(45) DEFAULT NULL COMMENT '中台售后单子单号',
	`origin_order_line_id` varchar(45) DEFAULT NULL COMMENT '外部子订单id',
	`outer_order_line_id` varchar(45) DEFAULT NULL COMMENT '中台售后子id',
	`origin_order_id` varchar(45) DEFAULT NULL COMMENT '外部主订单id',
	`outer_order_id` varchar(45) DEFAULT NULL COMMENT '中台主订单id',
	`origin_item_id` varchar(45) DEFAULT NULL COMMENT '外部商品id',
	`outer_item_id` varchar(45) DEFAULT NULL COMMENT '中台商品id',
	`origin_sku_id` varchar(45) DEFAULT NULL COMMENT '外部商品SKU id',
	`outer_sku_id` varchar(45) DEFAULT NULL COMMENT '中台商品sku id',
	`goods_status` tinyint(3) DEFAULT NULL COMMENT '货物状态
{@link com.alibaba.cz.reverse.constants.GoodsStatusEnum}',
	`after_refund_status` tinyint(3) DEFAULT NULL COMMENT '售后退款状态:1-买家已经申请退款，等待卖家同意;4-退款关闭;5-退款成功 6-卖家拒绝退款',
	`currency_price` bigint(20) DEFAULT NULL COMMENT '退款金额',
	`refund_count` bigint(20) DEFAULT NULL COMMENT '退款件数',
	`compensate_fee` bigint(20) DEFAULT NULL COMMENT '赔付金额',
	`reason_id` int(11) DEFAULT NULL COMMENT '买家申请原因id',
	`reverse_desc` varchar(5000) DEFAULT NULL COMMENT '退款描述',
	`message_pic` varchar(5000) DEFAULT NULL COMMENT '上传凭证图片',
	`message_pic_desc` varchar(5000) DEFAULT NULL COMMENT '上传图片说明, 不能包含逗号等特殊符号 多个图片的说明内部会通过“,”分隔之后存储',
	`sync_version` int(11) DEFAULT NULL COMMENT '是否已经同步中台：0未同步，1已同步，',
	`gmt_create` datetime DEFAULT NULL COMMENT '第三方平台的创建时间',
	`gmt_modified` datetime DEFAULT NULL COMMENT '第三方平台的修改时间',
	`sys_time` bigint(20) NOT NULL COMMENT '同步更新时间，乐观锁',
	`platform_type` tinyint(3) DEFAULT NULL COMMENT '平台类型 1 天猫 2 pdd',
	`update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '本地数据库更新时间',
	`buyer_id` varchar(45) DEFAULT NULL COMMENT '买家ID',
	`seller_id` varchar(45) DEFAULT NULL COMMENT '卖家主账号',
	`reverse_type` tinyint(3) DEFAULT NULL COMMENT '售后类型
{@link com.alibaba.cz.reverse.constants.ReverseTypeEnum}',
	`sync_ability` tinyint(3) DEFAULT NULL COMMENT '同步中台',
	`reverse_version` varchar(45) NOT NULL COMMENT '售后单批次，一个订单一次申请售后请求下的所有售后单为一个批次',
	`features` varchar(4096) DEFAULT NULL COMMENT '扩展字段',
	PRIMARY KEY (`id`),
	UNIQUE KEY `index6` (`origin_reverse_id`, `origin_sku_id`, `platform_type`),
	KEY `outer_order_id` (`outer_order_id`),
	KEY `sync_version` (`sync_version`),
	KEY `outer_reverse_id` (`outer_reverse_id`),
	KEY `origin_reverse_id` (`origin_reverse_id`, `platform_type`),
	KEY `origin_order_id` (`origin_order_id`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8  
```



LOCAL环境SQL脚本

```mysql
ALTER TABLE `test`.`oms_reverse` 
ADD COLUMN `handle_type` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '处理类型：无需人工处理、需人工处理、定时处理' AFTER `features`,
ADD COLUMN `business_type_error` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '报错分类：创单、地址、会员异常、履约异常、确认收货、商品、售后完成、系统异常、已发货、营销、其他' AFTER `handle_type`,
ADD COLUMN `display_error_content` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '前端展示报错内容' AFTER `business_type_error`,
ADD COLUMN `error_code` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '错误码 暂时为空 预留字段' AFTER `display_error_content`;
```



UAT2 环境SQL脚本

```mysql
ALTER TABLE `fh_oms_uat2`.`oms_reverse` 
ADD COLUMN `handle_type` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '处理类型：无需人工处理、需人工处理、定时处理' AFTER `features`,
ADD COLUMN `business_type_error` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '报错分类：创单、地址、会员异常、履约异常、确认收货、商品、售后完成、系统异常、已发货、营销、其他' AFTER `handle_type`,
ADD COLUMN `display_error_content` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '前端展示报错内容' AFTER `business_type_error`,
ADD COLUMN `error_code` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '错误码 暂时为空 预留字段' AFTER `display_error_content`;
```

PROD 环境SQL脚本

```sql
ALTER TABLE `fh_oms_ywzt`.`oms_reverse` 
ADD COLUMN `handle_type` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '处理类型：无需人工处理、需人工处理、定时处理' AFTER `features`,
ADD COLUMN `business_type_error` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '报错分类：创单、地址、会员异常、履约异常、确认收货、商品、售后完成、系统异常、已发货、营销、其他' AFTER `handle_type`,
ADD COLUMN `display_error_content` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '前端展示报错内容' AFTER `business_type_error`,
ADD COLUMN `error_code` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '错误码 暂时为空 预留字段' AFTER `display_error_content`;
```



阿里云定时任务需要配置。

com.alibaba.rainbow.core.service.trade.scheduler.JdReverseOrderFetchProcessor

corn表达式：

```
0 0 0/4 * * ?
```

ACM 配置

```properties
# 售后单定时重试 时间 单位 毫秒
order.reverse.retry.time.ms=604800000
```

![image-20230331041615126](image-20230331041615126.png)
