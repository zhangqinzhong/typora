# 三方售后单

以拼多多举例：

* tb发送售后消息到rainbow
* rainbow接受消息com.alibaba.rainbow.core.service.trade.mq.consumer.OrderSysPddListener
* 选择合适的消息实现类，比如这个是拼多多退款创建消息com.alibaba.rainbow.core.service.trade.mq.service.impl.pdd.RefundCreatedExecute#handlerRequest
* 消息体转换，关键判断逻辑，如果不是`仅退款`的消息 直接return消息丢失
* 是仅退款的消息
* 查询三方订单详情，关键判断，`未支付`的订单直接return
* 关键判断，判断临时表是否存在订单信息，不存在则执行创单逻辑，同步创建完成后更新订单信息`操作链`
* 临时表存在订单信息则更新。更新完成后更新订单信息`操作链`
* 处理售后信息
* 关键判断，判断是否是页面导入的订单信息，是，直接return 消息丢失
* 查询本地数据库获取子订单信息
* 同步售后单，判断OmsReverse表是否存在，不存在插入
* 关键判断，数据库中的同步时间大于现在要同步的时间，当前同步消息是过期数据，无需处理
* 更新OmsReverse表



同步售后消息结束



#### 定时任务扫描oms_order表 根据表中存在售后操作链进行逻辑处理

1. 如果存在售后操作链则重新发送MQ到rainbow
2. rainbow消费售后操作链消息进行售后逻辑
3. 异常出现在售后逻辑中

订单日志表记录的异常信息：

|   Id    |                         display_msg                          |     gmt_create      | operate_type |
| :-----: | :----------------------------------------------------------: | :-----------------: | :----------: |
| 2857438 |                         创建中台订单                         | 2022-05-08 18:59:01 |      0       |
| 2857445 | 创建售后单发生异常;错误信息:本地错误消息:创建售后单中台返回异常;orderId=9300000252486196276;中台错误消息:撤销失败，撤销异常，没有找到有效的履约单，请更换售后方式重新发起！ | 2022-05-08 18:59:01 |      3       |
| 2894492 |                        创建售后单成功                        | 2022-05-13 22:20:02 |      3       |
| 2894493 |                        售后单操作成功                        | 2022-05-13 22:20:04 |      5       |
| 4570593 | 创建售后单发生异常;错误信息:本地错误消息:创建售后单中台返回异常;orderId=9300000252486196276;中台错误消息:撤销失败，撤销异常，仅退款拦截发货失败,发货撤回失败，请更换售后方式重新发起！ | 2022-11-09 17:09:53 |      3       |
| 4570614 |                        创建售后单成功                        | 2022-11-09 17:12:46 |      3       |
| 4570615 |                        售后单操作成功                        | 2022-11-09 17:12:47 |      5       |

异常信息出现的地方：

com.alibaba.rainbow.core.service.trade.business.reverse.ReverseOptService#applyReverseSubmit


