# 1219计划

配置独立导单星鲜优选默认会员

阿里侧数据库

```sql
INSERT INTO cz_user(id,`name`,gender,version,tenant_id,nick,`status`,source_type)
VALUES ('U114548832050766279','独立导单优选默认会员',1,1,'fh01','User2e52d33b6e314c24909f1fe6e8e099fcd',1,'NORMAL');
```

默认用户ID：U114548832050766279



纪元需要重新上传模板文件

 [独立订单导单模版.xlsx](独立订单导单模版.xlsx) 



配置独立导单优选默认用户不能加黑

在RAM子用户的应用配置管理内配置



飞鹤侧：

DataID UserElementSwitch

groupId：user.switch



USER_INDEX="cz_user"
USER_INDEX_TYPE="cz_user"
IS_NEED_SYNC_USER_INDEX=true
IS_MOCK_TOUCH_SEND=false
IS_MOCK_TRANS=false
MOCK_PHONE=13212700533
DEFAULT_APP_ID="wx51d736fb510a02a7"
DEMOTE_USER_BLACK_IDS=["U114548832050766276","U114548832050766279"]
NEED_CREATE_USER_UNION_ID_INDEX_LIST=[]





1. REFUND_CREATED: 买家发起售后申请(200)
   * 需要查询我们这边主品是否全部发起了售后 ，如果是 并且存在赠品 则赠品也需要发起售后 需要判断是抖音赠品
   * 如果发起售后的主品 存在渠道加赠 则判断一下主赠关系 如果存在赠品 则赠品也需要发起售后

2. REFUND_AGREED: 同意退款(201)
   * 参考天猫代码逻辑，自动审核通过（自动同意退款。）    （原计划1219改）
   * 判断主品是否全部退完 如果是 则赠品也需要发起售后。和买家发起售后申请逻辑一致。
3. REFUND_CLOSED: 售后关闭(207)
   * 关闭中台对应售后单
4. REFUND_REFUSED: 拒绝退款(204)
   * 关闭中台对应售后单





Adapter-tb  接受抖音消息

- 发送到rainbow rainbow消费者接收消息com.alibaba.rainbow.core.service.trade.douyin.mq.consumer.OrderSysDyListener
- rainbow 存入数据到临时表

定时任务扫描临时表 去同步中台订单

定时任务：com.alibaba.rainbow.core.service.trade.douyin.scheduler.DyOrderSysProcessor#process

此时有个判断：如果临时表中已经存在中台订单号则执行如下逻辑：

如果操作链中有退款操作链 操作链代码 = 4

com.alibaba.rainbow.core.service.trade.douyin.business.order.origin.DyOrderCenterSyncService#updateOrderToAbility

则会重新发送MQ消息：

MQ 

key = 中台订单号

tag = dySyncReverse

此时会被com.alibaba.rainbow.core.service.trade.douyin.mq.consumer.RainbowDyOrderListener重新消费

消费的具体实现类:

com.alibaba.rainbow.core.service.trade.douyin.mq.service.impl.callback.DyReverseSysExecute#check

代码逻辑：

会通过

merchantId

outOrderId

OutOrderTypeEnum.FORWARD.getType()      【正向订单】

查询com.alibaba.cloud.retail.delivery.normal.api.FulfillmentOrderAbilityService#queryFulfillmentOrder

判断是否存在履约单，不存在直接抛出异常

存在：

查询当前订单需要处理的售后单，并将订单数据赋值给售后单

如果售后单currencyPrice为null

则查询抖音API 获取退款信息

将查询到的退款信息赋值给售后单



如果中台售后单子单号为null

将需要同步的退款单根据批次划分主子售后单



然后就是按批次去中台创建售后单

然后定义了一个Map  key是批次号：reverseVersion  value是这一批的售后单集合

遍历这个Map

给每一个售后单都标记是否是快速退款：value.forEach(x -> x.setFastRefund(omsOrder.getFastRefund()));

按批次去中台创建售后单com.alibaba.cz.reverse.normal.api.ReverseAbilityService#applyReverseSubmit

同步将中台返回信息同步到数据库

调用中台接口获取订单信息

com.alibaba.cz.trade.normal.query.api.OrderQueryAbilityService#querySingle

抖音仅退款售后单创建异步监控履约单状态

调用 com.alibaba.adapter.api.tiktok.DoudianApiService#orderInfoQuery 查询订单信息



关键方法

com.alibaba.rainbow.core.service.trade.douyin.business.reverse.DyReverseSyncService#agreeGift



获取抖音售后单信息

com.alibaba.adapter.api.tiktok.DoudianApiService#getAfterSaleList

判断返回的结果中是否存在售后申请，售后成功的订单状态，如果包含则迭代一个数值count。

判断count 和 通过查询com.alibaba.adapter.api.tiktok.DoudianApiService#orderInfoQuery 获取到的售后单数量是否一致

其实就是调用了2个接口 1个是订单详情 1个是售后单列表

判断2个数值是否相等



![image-20221206005837118](image-20221206005837118.png)

相等才会走逻辑处理 主品退 赠品关联退



1.自动同意退款

2.赠品关联退



抖音同意退款消息模型转换前:

traceId: eaac11b53416703180935953102d02cb	

```json
{
    "body": "eyJhZnRlcnNhbGVTdGF0dXMiOjEyLCJhZ3JlZVRpbWUiOiIyMDIyLTEyLTA2IDE3OjE0OjUwIiwicmVmdW5kUG9zdEFtb3VudCI6MCwicElkIjo1MDA4ODYxMTM5MTUzNTEyMzQ2LCJhZnRlcnNhbGVUeXBlIjoyLCJ0YWciOjIwMSwic2hvcElkIjo0NDYzNzk4LCJzSWQiOjUwMDg4NjExMzkxNTM1MTIzNDYsImFmdGVyc2FsZUlkIjo3MTczOTYxNTcxMTM0MTEyMDM5LCJyZWZ1bmRBbW91bnQiOjF9",
    "bornHost": "/172.17.181.52:53256",
    "bornTimestamp": 1670318093596,
    "key": "5008861139153512346",
    "msgID": "AC11B53402CB4E31C3EC1D73451C89B0",
    "reconsumeTimes": 0,
    "shardingKey": "",
    "startDeliverTime": 0,
    "tag": "REFUND_AGREED",
    "topic": "CZ_ADAPTER_TRADE_DOUDIAN_MONITOR",
    "userProperties": {
        "MSG_REGION": "cn-beijing",
        "EagleEye-IP": "172.17.181.52",
        "UNIQ_KEY": "AC11B53402CB4E31C3EC1D73451C89B0",
        "EagleEye-pRpc": "/tiktok/trade/order/msg",
        "TRACE_ON": "true",
        "CONSUME_START_TIME": "1670318093600",
        "EagleEye-Sampled": "s0",
        "EagleEye-SpanID": "-6848372265834371887",
        "INSTANCE_ID": "MQ_INST_1071794100325015_BXhF52pt",
        "EagleEye-RpcID": "0.1",
        "EagleEye-pSpanID": "7978956442308970762",
        "EagleEye-UserData": "tbs=frs",
        "EagleEye-ROOT-APP": "0b7228a1-7c8c-4da6-8eff-a86825ebda0f",
        "EagleEye-pAppName": "0b7228a1-7c8c-4da6-8eff-a86825ebda0f",
        "EagleEye-TraceID": "eaac11b53416703180935953102d02cb"
    }
}
```

抖音同意退款消息模型转换

```json
{
    "aftersaleId": 7173961571134112039,
    "aftersaleStatus": 12,
    "aftersaleType": 2,
    "agreeTime": "2022-12-06 17:14:50",
    "fastRefund": false,
    "pId": 5008861139153512346,
    "refundAmount": 1,
    "sId": 5008861139153512346,
    "shopId": 4463798,
    "tag": 201
}
```



消息到达rainbow的时候，还没有创建售后单，或者没有创建完毕，导致退款成功消息的丢失。

![image-20221209150735106](image-20221209150735106.png)





同意退款消息：tb发送到rainbow时候，MQ设置延迟投递参数，消息延迟10分钟投递

![image-20221210123212392](image-20221210123212392.png)



