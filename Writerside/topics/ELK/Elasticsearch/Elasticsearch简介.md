# Elasticsearch

> Elasticsearch是实时全文搜索和分析引擎，提供搜集、分析、存储数据三大功能；是一套开放REST和JAVA API等结构提供高效搜索功能，可扩展的分布式系统。它构建于Apache Lucene搜索引擎库之上。

> *TF-IDF*（term frequency–inverse document frequency）是一种用于信息检索与数据挖掘的常用加权技术。TF是词频(Term Frequency)，IDF是逆文本频率指数(Inverse Document Frequency)。

## 初步认识Elasticsearch

1. 我个人的简单理解：

> 使用java语言实现的分布式全文搜索框架，（我个人把它理解为一个数据库）

它有一些特点，提供搜集、分析、存储数据三大功能。新增到ES的数据，1秒后就可以被搜索到，这种新增数据对搜索的可见性被称为“准实时搜索”。分布式，意味着可以动态调整集群规模，弹性扩容。集群还支持上千个节点，但是分片不宜过多。主节点在管理大量分片时会面临比较大的压力。

底层是采用Lucene框架。用于处理纯文本的数据。提供了建立索引，执行搜索等接口，但是不包含分布式服务，ES就是对Lucene做了增强，优化，改进。

全文指的是对全部的文本进行分析，建立索引，使数据可以被搜索，因此称为全文。

2. 索引结构

ES是面向文档的，文档格式一般为JSON，所以它可以有很多字段，在创建索引的时候，需要描述文档中每个字段的数据类型，并且可能需要指定不同的分析器。

在存储结构上，由 `_index,` `_type` `_id`唯一标识一个文档。

* _index: 指向一个或多个物理分片的逻辑命名空间
* _type: 用于区分同一个集合中的不同细分（7.x版本已经移除）
* _id: 文档标识符，具有唯一性，由系统生成或者用户指定

3. 分片（shard）

分布式环境下，单台机器无法存储大量的数据，要依靠集群（多台机器）来存储，因此，需要将数据拆分成若干小块分配到各个机器上，然后通过某种路由策略找到某个数据块的位置。

除了将数据分片提高水平扩展能力，分布式存储还会把数据复制成多个副本，增加系统可用性，并且还可以实现部分读操作的并发执行，但是多数据副本也带来了数据一致性的问题。

为了应对并发更新问题，ES将数据副本分为主从两个部分，即：主分片（primary shard）和副分片（replica shard）。主数据作为权威数据，写过程先写主分片，成功后再写副分片，恢复阶段以主分片为准。

![image-20220922142024332](image-20220922142024332.png)

分片（shard）是底层的基本读写单元，分片的目的是分割巨大索引，让读写可以并行操作，由多台机器共同完成。读写请求最终落在某个分片上，分片可以独立执行读写工作。ES利用分片将数据分发到集群内各处，分片是数据的容器，文档保存在分片内，不会跨分片存储，分片又被分配到集群各个节点里。当集群规模扩大或者缩小的时候，ES会自动在各节点中迁移分片，使数据仍然均匀分布在集群中。

索引与分片的关系：

![image-20220922152955008](image-20220922152955008.png)

一个ES索引包含多个分片，一个分片是一个Lucene的索引，这个Lucene索引本身是一个完整的搜索引擎，可以独立执行建立索引和搜索任务。Lucene索引又由很多分段组成，每个分段都是一个倒排索引。ES每次 `refresh` 都会生成一个新的分段，其中包含若干文档的数据。在每个分段内部，文档的不同字段被单独建立索引，每个字段的若干值由若干词（Term）组成，Term是原文本内容经过分词器处理和语言处理后的最终结果（例如，去掉标点符号和转换为词根）。
