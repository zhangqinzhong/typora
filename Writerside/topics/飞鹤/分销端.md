# 分销端

https://uat2-oms.feihe.com/ui/cr_distribution/blank/login?sourceUrl=http%3A%2F%2Fuat2-oms.feihe.com%2Fui%2Fcr_distribution%2Findex%3Ftab%3DdistributionCenter#/cr_distribution/consttrade-OrderManage 

账号：yichipdd

密码：yichi123456



### 代销批量导入

纪元应用：cr_distribution

纪元Excel服务：distribution_trade_order_import



1. 导入Excel

2. Excel订单源数据丰富

   1. input

   2. 获取城市数据源(distribution_region_data_source)

      1. 查cz_store库region表获取省级行政区划（ div_level = 1  and  state = true ）【div——level： '区划级别：1 省 2 市 3 区 4县 5 街道 、村' ，state：'1: 正常  2：停用',】

           2. 遍历获取到的省级行政区划，（ parent_code = ${code} [上面查到的省的字段code]  and  state = true ）

           3. 还是在遍历获取到的省级行政区划循环中，在获取市的基础上（ parent_code in ( codes ) [这里的codes是指上面获取到的市的code的集合] and state = true）

           4. ```java
              //runScript 
              Map<String, Object> result = new HashMap<>();
              
              Map<String, Object> province = input.get("province");
              List<Map<String, Object>> cityList = input.get("cityList");
              List<Map<String, Object>> districtList = input.get("districtList");
              
              result.put("label", province.get("name"));
              result.put("value", province.get("code"));
              List<Map<String, Object>> provinceChildren = new ArrayList<Map<String, Object>>();
              result.put("children", provinceChildren);
              
              List<Map<String, Object>> childrenCity = new ArrayList<>();
              Map<String, Map<String, Object>> childrenCityMap = new HashMap<>();
              for (int i = 0; i < cityList.size(); i++) {
              
                  Map<String, Object> cityListItem = cityList.get(i);
                  
                  String cityCode = cityListItem.get("code");
                  if (childrenCityMap.get(cityCode) != null) {
                      continue;
                  }
              
                  Map<String, Object> city = new HashMap<>();
                  city.put("label", cityListItem.get("name"));
                  city.put("value", cityCode);
                  city.put("children", new ArrayList<Map<String, Object>>());
              
                  provinceChildren.add(city);
                  childrenCityMap.put(cityCode, city);
              }
              
              for (int j = 0; j < districtList.size(); j++) {
                  Map<String, Object> districtListItem = districtList.get(j);
              
                  Map<String, Object> district = new HashMap<>();
                  district.put("label", districtListItem.get("name"));
                  district.put("value", districtListItem.get("code"));
              
                  List<Map<String, Object>> cityChildren = childrenCityMap.get(districtListItem.get("parent_code")).get("children");
              
                  cityChildren.add(district);
              }
              return result;
              
              ```

           5. ```json
              {
                  "label": "青海省",
                  "value": "630000",
                  "children": [
                      {
                          "lable": "西宁市",
                          "value": "630100",
                          "children": [
                              {
                                  "lable": "大通回族土族自治县",
                                  "value": "630121"
                              }
                          ]
                      }
                  ]
              }
              ```

   3. 遍历导入的订单

   4. 调用阿里接口com.alibaba.cz.store.normal.api.StoreQueryAbilityService.getStore,通过storeCode获取店铺信息

   5. 调用阿里接口com.alibaba.cz.item.normal.item.api.ItemSearchAbilityService.search,参数skuCode【渠道商品搜索】

   6. 数据校验，数据丰富

3. 查询授权店铺列表com.alibaba.cz.store.normal.api.StoreQueryAbilityService.queryStoreList

   1. for循环赋值授权店铺信息

4. 可售商品查询带优惠分销

   1. 可售商品列表查询

      1. 根据当前登录用户查询商家下店铺（com.alibaba.cz.store.normal.api.StoreQueryAbilityService.queryStoreByMerchantIdList 按商家ID列表查询店铺）

         1. ```json
            forEach
            {
              "lable":"storeName",
              "value":"storeId"
            }
            ```

         2. 获取filter(forEach.result, it -> (it.storeStatus=1 and it.businessStatus=1))的数据存入result

      2. foreach：merge(values.masterStoreIdList, it.masterStoreIdList) 存入masterStoreIdList字段

      3. 如果values.masterStoreIdList是空的，返回“不存在关联店铺”

      4. ⭐️查询店铺可售商品列表com.alibaba.rainbow.sdk.api.GuideSearchService.itemSearch  

      5. 循环赋值可售商品列表，返回可售商品列表

   2. 查询商家等级

      1. com.alibaba.cz.enterprise.ability.sdk.api.MerchantAbilityService.getMerchant 获取商家信息
      2. com.alibaba.cz.enterprise.ability.sdk.api.MerchantLevelAbilityService.getMerchantLevel 获取商家等级

   3. 查询商家角色，代销经销场景查询

      1. com.alibaba.cz.enterprise.ability.sdk.api.MerchantAbilityService.getMerchant 
      2. 判断是经销还是代销，merge逻辑判断关联商家未打标，不可下单，请联系开发同学处理
      3. 返回scenes场景

   4. 根据返回的scenes判断是经销还是代销，

      1. 代销：拼接营销入参，查询优惠信息，处理营销出参，循环判断是经销还是代销，dxDiscountPriceStr，或者是jxDiscountPriceStr，2个字段com.alibaba.cz.promotion.base.promotion.api.PromotionReadAbilityService.findPromotion

         ```script
         "¥" + if_case($it.discount = null, 
         decimal_format($it.price/100,"#,##0.00"), 
         decimal_format(($it.price-$it.discount)/100,"#,##0.00"))
         ```

      2. 经销：逻辑如上

   5. 赋值dxDiscountPriceStr，jxDiscountPriceStr俩都赋值了

5. 一段逻辑处理，

   1. 获取Excel源数据丰富的结果 ->  dataList
   2. 获取buyerId  ->  buyerId
   3. 获取查询授权店铺列表的结果  -> contentList
   4. 获取可售商品查询带优惠分销的结果   -> authItemList

6. 整理数据，执行脚本，数据校验

   ```java
   Map<String, Object> result = new HashMap<>();
   
   List<Map<String, Object>> dataList = input.get("dataList");
   List<Map<String, Object>> contentList = input.get("contentList");
   List<Map<String, Object>> authItemList = input.get("authItemList");
   Map<String, Object> failMessage = new HashMap<>();
   List<Map<String, String>> orderFailMessage = new ArrayList<>();
   List<Map<String, String>> indexFailMessage = new ArrayList<>();
   failMessage.put("all", "");
   failMessage.put("order", orderFailMessage);
   failMessage.put("index", indexFailMessage);
   result.put("failMessage", failMessage);
   
   // 同一个外部订单号时,需要保持一致的信息:店铺编码+收货人信息
   Map<String, Map<String, Object>> shouldSame = new HashMap<>();
   // 同一个外部订单号时，需要保持不一致的信息:skuid
   Map<String, List<String>> shouldDiff = new HashMap<>();
   //临时存储错误订单的集合
   List<String> tempFailOrders = new ArrayList<>();
   
   Map<String, Map<String, Object>> groupByOuterOrderId = new HashMap<>();
   // 为了按顺序导入
   List<String> outOrderIds = new ArrayList<>();
   
   String lastOuterOrderId = null;
   String lastFailMessage = null;
   
   long totalLqAmt = 0L;
   for (int i = 0; i < dataList.size(); i++) {
       if (lastFailMessage != null) {
           if (!tempFailOrders.contains(lastOuterOrderId)) {
               Map<String, String> lastFailDetail = new HashMap<>();
               lastFailDetail.put("outerOrderId", lastOuterOrderId);
               lastFailDetail.put("errorMessage", lastFailMessage);
               orderFailMessage.add(lastFailDetail);
               tempFailOrders.add(lastOuterOrderId);
           }
           Map<String, String> lastIndexFailDetail = new HashMap<>();
           lastIndexFailDetail.put("index", String.valueOf(i - 1));
           lastIndexFailDetail.put("errorMessage", lastFailMessage);
           indexFailMessage.add(lastIndexFailDetail);        
   
           lastOuterOrderId = null;
           lastFailMessage = null;
       }
   
       Map<String, Object> dataItem = dataList.get(i);
       String outerOrderId = dataItem.get("outerOrderId");
       if (StringUtils.isEmpty(outerOrderId)) {
           failMessage.put("all", "外部订单号不允许为空");
           break;
       }
       if (outerOrderId.length() > 30) {
           failMessage.put("all", "外部订单号长度不允许大于30");
           break;
       }
   
       Map<String, Object> order = groupByOuterOrderId.get(outerOrderId);
       if (order == null) {
           outOrderIds.add(outerOrderId);
           order = new HashMap<>();
           order.put("outerOrderId", outerOrderId);
           groupByOuterOrderId.put(outerOrderId, order);
       }
   
       lastOuterOrderId = outerOrderId;    
   
       String receiverName = dataItem.get("receiverName");
       if (StringUtils.isEmpty(receiverName) || receiverName.length() > 10) {        
           lastFailMessage = StringUtils.isEmpty(receiverName)?"收货人不能为空":"收货人长度不允许大于10";        
           continue;
       }
   
       String storeId = dataItem.get("storeId");
       String storeName = dataItem.get("storeName");
       String storeCode = dataItem.get("storeCode");
       String storeStatus = dataItem.get("storeStatus");
       String storeBusinessStatus = dataItem.get("storeBusinessStatus")
       if (StringUtils.isEmpty(storeCode) || storeCode.length() > 10) {
           lastFailMessage = StringUtils.isEmpty(storeCode)?"店铺编码不允许为空":"店铺编码长度不允许大于10";    
           continue;
       }
   
       if (StringUtils.isEmpty(storeId) || StringUtils.isEmpty(storeName)) {        
           lastFailMessage = "店铺编码无法解析为平台店铺";        
           continue;
       }
   
       if (!"1".equals(storeStatus) || !"1".equals(storeBusinessStatus)) {
           lastFailMessage = "店铺状态异常";        
           continue;
       }
   
       // 店铺编码强校验
       if (contentList == null){
           lastFailMessage = "未找到商家所属店铺";
           continue;
       }
       boolean isStoreCodeExist = false;
       for (int z = 0; z < contentList.size(); z++) {
           Map<String, Object> contentItem = contentList.get(z);
           if (storeCode.equals(contentItem.get("storeCode"))){
               isStoreCodeExist = true;
               break;
           }
       }
       if (!isStoreCodeExist){
           lastFailMessage = "该店铺不属于当前商家";
           continue;
       }
   
       String province = dataItem.get("provinceCode");
       String provinceName = dataItem.get("provinceName");
       if (StringUtils.isEmpty(province) || StringUtils.isEmpty(provinceName)) {        
           lastFailMessage = StringUtils.isEmpty(provinceName) ? "省不允许为空":"省不能解析为省编码";
           continue;
       }
       String city = dataItem.get("cityCode");
       String cityName = dataItem.get("cityName");
       if (StringUtils.isEmpty(city) || StringUtils.isEmpty(cityName)) {    
           lastFailMessage = StringUtils.isEmpty(cityName) ? "市不允许为空":"市不能解析为市编码或市非省的下级区划";
           continue;
       }
       String district = dataItem.get("districtCode");
       String districtName = dataItem.get("districtName");
       if (StringUtils.isEmpty(district) || StringUtils.isEmpty(districtName)) {     
           lastFailMessage = StringUtils.isEmpty(districtName) ? "区不允许为空":"区不能解析为区编码或区非市的下级区划";        
           continue;
       }
       String address = dataItem.get("address");
       if (StringUtils.isEmpty(address) || address.length() > 60) {        
           lastFailMessage = StringUtils.isEmpty(address)?"地址不允许为空":"地址长度不能超过60";
           continue;
       }
   
       String skuCode = dataItem.get("skuCode");
       if (StringUtils.isEmpty(skuCode) || skuCode.length() > 32) {        
           lastFailMessage = StringUtils.isEmpty(skuCode)? "SKUID不允许为空":"SKUID长度不能超过32";
           continue;
       }
   
       String itemNo = dataItem.get("itemNo");
       if (StringUtils.isEmpty(itemNo)) {        
           lastFailMessage = "SKUID无法解析";
           continue;
       }
   
       Integer quantity = dataItem.get("quantity");
       if (quantity == null || quantity <= 0 || quantity > 9999) {
           if (quantity == null) {
               lastFailMessage = "数量不允许为空";
           } else if (quantity <= 0)  {
               lastFailMessage = "数量不能小于1";
           } else {
               lastFailMessage = "数量不能超过9999";
           }
           continue;
       }
   
       //获取代销商品折扣价
       long disPrice = 0L;
       String isLq = dataItem.get("isLq");
       if (StringUtils.isEmpty(isLq)) {        
           isLq = "否";
       }
       if (isLq.equals("是")){
           Optional opt = authItemList.stream().filter(x -> x.get("skuCode").trim().equals(skuCode.trim())).findFirst();
           if (opt.isPresent()){
               Map<String, Object> authItem = opt.get();
               String price = authItem.get("dxDiscountPriceStr");
               String priceStr = price.substring(1).replace(",","");
               disPrice = Double.valueOf(priceStr) * 100;
           }
       }
       totalLqAmt += disPrice * quantity;
   
       String message = dataItem.get("message");
       if (message != null && message.length() > 40) {        
           lastFailMessage = "备注长度不能超过40";
           continue;
       }
   
       String receiverPhone = dataItem.get("receiverPhone");
       if (StringUtils.isEmpty(receiverPhone) || receiverPhone.length() != 11) {        
           lastFailMessage = StringUtils.isEmpty(receiverPhone)?"收货手机不允许为空":"收货手机无法解析";
           continue;
       } else {
           boolean wrongPhone = false;
           for (int charIndex = 0; charIndex < receiverPhone.length(); charIndex++) {
               if (!"0123456789-".contains(String.valueOf(receiverPhone.charAt(charIndex)))) {
                   wrongPhone = true;
                   break;
               }
           }
           if (wrongPhone) {
               lastFailMessage = "收货手机无法解析";
               continue;
           }
       }
   
       Map<String, Object> shouldSameValue = shouldSame.get(outerOrderId);    
       if (shouldSameValue == null) {
           order.put("receiverName", receiverName);
           order.put("receiverPhone", receiverPhone);
           order.put("provinceCode", province);
           order.put("cityCode", city);
           order.put("districtCode", district);
           order.put("provinceName", provinceName);
           order.put("cityName", cityName);
           order.put("districtName", districtName);
           order.put("address", address);
           order.put("message", message);
           order.put("storeId", storeId);
           order.put("storeName", storeName);
           order.put("isLq", isLq);
   
           shouldSame.put(outerOrderId, order);
       } else {
           boolean hasDiff = true;
           if (!storeId.equals(shouldSameValue.get("storeId"))) {
               lastFailMessage = "同外部订单号，店铺编码不一致";
           } else if (!receiverName.equals(shouldSameValue.get("receiverName"))) {
               lastFailMessage = "同外部订单号，收货人不一致";
           } else if (!provinceName.equals(shouldSameValue.get("provinceName"))) {
               lastFailMessage = "同外部订单号，省不一致";
           } else if (!cityName.equals(shouldSameValue.get("cityName"))) {
               lastFailMessage = "同外部订单号，市不一致";
           } else if (!districtName.equals(shouldSameValue.get("districtName"))) {
               lastFailMessage = "同外部订单号，区不一致";
           } else if (!address.equals(shouldSameValue.get("address"))) {
               lastFailMessage = "同外部订单号，地址不一致";
           } else if (!receiverPhone.equals(shouldSameValue.get("receiverPhone"))) {
               lastFailMessage = "同外部订单号，收货手机不一致";
           } else {
               hasDiff = false;
           }
           if (hasDiff) {
               continue;
           }
       }
       
       List<Map<String, Object>> itemList = order.get("itemList");
       if (itemList == null) {
           itemList = new ArrayList<>();
           order.put("itemList", itemList);
       }
       
       boolean isItemExist = false;
       for (int j = 0; j < itemList.size(); j++) {
           Map<String, Object> existItem = itemList.get(j);
           if (skuCode.equals(existItem.get("skuCode"))) {
               isItemExist = true;
               break;
           }
       }
   
       if (isItemExist) {
           lastFailMessage = "同外部订单号，已存在同SKUID商品";
           continue;
       }
   
       Map<String, Object> item = new HashMap<>();
       item.put("itemNo", itemNo);
       item.put("skuCode", skuCode);
       item.put("quantity", quantity);
       itemList.add(item);
   
       if (itemList.size() > 20) {        
           lastFailMessage = "同一主单下商品种类不应超过20";
           continue;
       }
   }
   
   if (lastFailMessage != null) {
       if (!tempFailOrders.contains(lastOuterOrderId)) {
           Map<String, String> lastFailDetail = new HashMap<>();
           lastFailDetail.put("outerOrderId", lastOuterOrderId);
           lastFailDetail.put("errorMessage", lastFailMessage);
           orderFailMessage.add(lastFailDetail);
           tempFailOrders.add(lastOuterOrderId);
       }
       Map<String, String> lastIndexFailDetail = new HashMap<>();
       lastIndexFailDetail.put("index", String.valueOf(dataList.size() - 1));
       lastIndexFailDetail.put("errorMessage", lastFailMessage);
       indexFailMessage.add(lastIndexFailDetail);  
   }
   
   List<Map<String, Object>> orderList = new ArrayList<>();
   for(String outOrderId: outOrderIds){
       if(null != groupByOuterOrderId.get(outOrderId)){
           orderList.add(groupByOuterOrderId.get(outOrderId));
       }
   }
   
   //礼券总金额
   result.put("totalLqAmt", totalLqAmt);
   //订单列表
   result.put("content", orderList);
   
   return result;
   ```

7. 获取礼券的可用余额

   1. com.alibaba.cz.promotion.base.coupon.api.CouponInstanceAbilityService.queryCouponInstanceList(查询礼券账户)
   1. com.alibaba.cz.promotion.base.coupon.api.CashCouponAbilityService.queryAvailableAmount(从db中查询账户礼券可用余额)
   1. 返回avaliableAmount

8. 判断礼券余额是否充足avaliableAmount = null or runScript.result.totalLqAmt > avaliableAmount -> 导单失败，礼券余额不足。

9. for循环上面脚本的结果result

   1. anyMatch(runScript.result.failMessage.order, o -> o.outerOrderId = $it.outerOrderId) = false 拿到没有异常信息的订单 

   2. 遍历itemList，（itemList存的是商品信息）执行查询可售商品查询，

      1. 根据当前登录用户查询商家下店铺（com.alibaba.cz.store.normal.api.StoreQueryAbilityService.queryStoreByMerchantIdList 按商家ID列表查询店铺）

         1. ```json
            forEach
            {
              "lable":"storeName",
              "value":"storeId"
            }
            ```

         2. 获取filter(forEach.result, it -> (it.storeStatus=1 and it.businessStatus=1))的数据存入result

      2. foreach：merge(values.masterStoreIdList, it.masterStoreIdList) 存入masterStoreIdList字段

      3. 如果values.masterStoreIdList是空的，返回“不存在关联店铺”

      4. ⭐️查询店铺可售商品列表com.alibaba.rainbow.sdk.api.GuideSearchService.itemSearch  

      5. 循环赋值可售商品列表，返回可售商品列表

   3. 拿到上一步通过判断的数据，渲染，并且创建订单
      1. 判断是否新客com.alibaba.cz.user.ability.sdk.api.UserNewCustomerAbilityService.isNewCustomer
      2. com.alibaba.cz.user.ability.sdk.api.UserAbilityService.findBasicUserByPhone 根据手机号查询用户信息
      3. extraParams：merge($.mappingNewCustomer, $.mappingAddedBuyer)存入扩展字段

   4. 构建参数，请求com.alibaba.cz.trade.normal.placeorder.api.PlaceOrderAbilityService.renderOrder 渲染订单

   5. com.alibaba.cz.promotion.base.coupon.api.CouponInstanceAbilityService.queryCouponInstanceList分销商礼券账户信息查询

   6. com.alibaba.cz.promotion.base.coupon.api.CashCouponAbilityService.queryAvailableAmount(从db中查询账户礼券可用余额)

   7. 获取上面第三条渲染订单的一个数据linkageDTO.submitParams

   8. 判断是否是礼券支付

   9. 如果不是礼券支付，或者avaliableAmount营销礼券余额不足，设置nonDudection=true,否则执行一段脚本去计算，如何$values.availableCount - $.runScript.result.deductionAmount < 0 设置nonDudection=true

   10. 如果nonDudection=true，重新渲染Excel导入的订单
       1. 执行新赠客逻辑如上
       2. 执行脚本
       3. com.alibaba.cz.trade.normal.placeorder.api.PlaceOrderAbilityService.adjustRender 调整渲染订单
       4. 返回submitParams =  $.callRPC.result.result.linkageDTO.submitParams

   11. 创建订单
       1. 如果scene = "distributor" 创建经销订单 
          1. com.alibaba.cz.enterprise.ability.sdk.api.MerchantAbilityService.getMerchant 获取商家信息
          2. 获取com.alibaba.cz.promotion.base.coupon.api.CouponInstanceAbilityService.queryCouponInstanceList 分销商礼券账户信息查询
          3. com.alibaba.cz.promotion.base.coupon.api.CashCouponAbilityService.queryAvailableAmount从db中查询账户礼券可用余额
          4. 判断礼券余额是否发生变动
          5. 创建订单com.alibaba.cz.trade.normal.placeorder.api.PlaceOrderAbilityService.createOrder
          6. 根据结果判断子订单应付金额是否一致，不一致给出提示金额或优惠发生变化，请刷新后重新提交
          7. 判断是否是0元订单，$.input.zeroOrder=true 如果是，直接返回
          8. 批量创建支付单com.alibaba.cz.trade.normal.payment.api.OrderPayAbilityService.batchCreateOutPayOrder
       2. else创建代销订单
          1. com.alibaba.cz.enterprise.ability.sdk.api.MerchantAbilityService.getMerchant 获取商家信息
          2. 查询订单列表com.alibaba.cz.trade.normal.query.api.OrderSearchAbilityService.search
          3. 判断是否已经存在外部订单号
          4. 判断收货人电话是否为空
          5. 下单时注册会员
             1. 判断isTelPhone 固定电话查询用户 com.alibaba.cz.user.ability.sdk.api.UserAbilityService.findBasicUserByTelephone
             2. Else.根据历史手机号查询用户id com.alibaba.cz.user.ability.sdk.api.UserHistoryPhoneRecordAbilityService.findUserIdByHistoryPhone
                * 如果是空,根据用户id查询用户信息 com.alibaba.cz.user.ability.sdk.api.UserAbilityService.findBasicUserById
                * else 查买家信息com.alibaba.cz.user.ability.sdk.api.UserAbilityService.findBasicUserByPhone
             3. 如果用户ID是空，注册会员com.alibaba.cz.user.ability.sdk.api.UserRegisterAbilityService.register,返回outId和channelUserId
             4. else 判断relation_distributor_merchant_ids 是否包含传入的merchantId，如果是，则更新会员信息com.alibaba.cz.user.api.UserService.modify
             5. 返回结果
          6. 判断是否创建会员成功
          7. 构建创建订单request，
          8. 获取com.alibaba.cz.promotion.base.coupon.api.CouponInstanceAbilityService.queryCouponInstanceList 分销商礼券账户信息查询
          9. com.alibaba.cz.promotion.base.coupon.api.CashCouponAbilityService.queryAvailableAmount从db中查询账户礼券可用余额
          10. 判断礼券余额是否发生变动
          11. 创建订单com.alibaba.cz.trade.normal.placeorder.api.PlaceOrderAbilityService.createOrder
          12. 根据结果判断子订单应付金额是否一致，不一致给出提示金额或优惠发生变化，请刷新后重新提交
          13. 判断是否是0元订单，$.input.zeroOrder=true 如果是，直接返回
          14. 批量创建支付单com.alibaba.cz.trade.normal.payment.api.OrderPayAbilityService.batchCreateOutPayOrder

10. 获取异常信息

11. 执行一段脚本写入异常信息

12. 结束



### 订单维度导出订单

cr_distribution

distribution_reverse_submit



### 商品维度导出订单

cr_distribution

distribution_trade_order_item_export



查询订单列表	

com.alibaba.cz.trade.normal.query.api.OrderSearchAbilityService.search

查缺货订单

com.alibaba.cloud.retail.delivery.normal.api.FulfillmentOrderAbilityService.searchHoldOrders

查询物流详情

com.alibaba.cloud.retail.delivery.normal.api.ParcelAbilityService.queryParcels



### 申请退款

cr_distribution

distribution_reverse_submit



### 查询物流

cr_distribution

distribution_delivery_parcels_search





```json
{
    "scene": "agent",
    "submitParams": "{\"addressParamDTO\":{\"selectedAddressId\":\"DAI-1\"},\"buyerParamDTO\":{\"buyerId\":\"U347550423274010048\"},\"extraParams\":{\"channelOrderId\":\"876545654343\",\"selectedAddressId\":\"DAI-1\",\"districtCode\":\"110101\",\"address\":\"756435\",\"city\":\"北京市\",\"provinceCode\":\"110000\",\"cityCode\":\"110100\",\"receiverName\":\"432423423\",\"distribution_merchant_id\":\"100331\",\"distributionScene\":\"daixiao\",\"channelStoreId\":\"2000473782\",\"province\":\"北京市\",\"mobilePhone\":\"17600260977\",\"district\":\"东城区\",\"newCustomer\":\"1\",\"distributionSellerId\":\"100331\",\"channelStoreName\":\"hps分销自营店\"},\"orderParamDTOList\":[{\"deliveryParamDTO\":{\"selectedDeliveryType\":\"1\"},\"orderLineParamDTOList\":[{\"extraParams\":{},\"itemId\":\"437785727578359550\",\"normOrderLine\":true,\"orderLinePriceParamDTO\":{\"totalAssetDiscountFee\":{\"amount\":0.00,\"cent\":0,\"currency\":\"CNY\"},\"totalItemDiscountFee\":{\"currencyPrice\":{\"amount\":1.35,\"cent\":135,\"currency\":\"CNY\"}},\"totalShareCrossShopDiscountFee\":{\"currencyPrice\":{\"$ref\":\"$.orderParamDTOList[0].orderLineParamDTOList[0].orderLinePriceParamDTO.totalAssetDiscountFee\"}},\"totalShareShopDiscountFee\":{\"$ref\":\"$.orderParamDTOList[0].orderLineParamDTOList[0].orderLinePriceParamDTO.totalShareCrossShopDiscountFee\"},\"unitPrice\":{\"currencyPrice\":{\"amount\":5.00,\"cent\":500,\"currency\":\"CNY\"}}},\"orderLineType\":0,\"originalOutId\":\"876545654343\",\"outId\":\"0b99acc0adcbe9dea0b272a2d6603045\",\"quantity\":1,\"skuId\":\"437785727582553711\"},{\"extraParams\":{},\"itemId\":\"441715696818233784\",\"normOrderLine\":true,\"orderLinePriceParamDTO\":{\"totalAssetDiscountFee\":{\"$ref\":\"$.orderParamDTOList[0].orderLineParamDTOList[0].orderLinePriceParamDTO.totalAssetDiscountFee\"},\"totalItemDiscountFee\":{\"currencyPrice\":{\"amount\":0.27,\"cent\":27,\"currency\":\"CNY\"}},\"totalShareCrossShopDiscountFee\":{\"$ref\":\"$.orderParamDTOList[0].orderLineParamDTOList[0].orderLinePriceParamDTO.totalShareCrossShopDiscountFee\"},\"totalShareShopDiscountFee\":{\"$ref\":\"$.orderParamDTOList[0].orderLineParamDTOList[0].orderLinePriceParamDTO.totalShareCrossShopDiscountFee\"},\"unitPrice\":{\"currencyPrice\":{\"amount\":1.00,\"cent\":100,\"currency\":\"CNY\"}}},\"orderLineType\":0,\"originalOutId\":\"876545654343\",\"outId\":\"8ff0f2c60f6f436838262be2ddea8fff\",\"quantity\":1,\"skuId\":\"442873961665222247\"}],\"outId\":\"A05528122F868AEB959ED74192866E11\",\"paymentParamDTO\":{\"selectedPaymentMethodCode\":\"2\"},\"priceParamDTO\":{\"shippingFee\":0},\"splitTraceInfo\":\"{\\\"splitInfos\\\":[{\\\"split\\\":false,\\\"splitId\\\":\\\"com.feihe2.daixiao\\\",\\\"splitReason\\\":\\\"bizCode\\\"},{\\\"split\\\":false,\\\"splitId\\\":\\\"normal_trade_base_line\\\",\\\"splitReason\\\":\\\"businessCode\\\"},{\\\"split\\\":false,\\\"splitId\\\":\\\"2000473783\\\",\\\"splitReason\\\":\\\"store\\\"},{\\\"split\\\":false,\\\"splitId\\\":\\\"A05528122F868AEB959ED74192866E11_0\\\",\\\"splitReason\\\":\\\"delivery\\\"}]}\"}],\"promotionParamDTO\":{\"itemPromotionParamDTOList\":[{\"outId\":\"8ff0f2c60f6f436838262be2ddea8fff\",\"promotionIdValues\":[\"com.feihe2.daixiao-gradeDiscount-295392269811270479_295392271110632861\"]},{\"outId\":\"0b99acc0adcbe9dea0b272a2d6603045\",\"promotionIdValues\":[\"com.feihe2.daixiao-gradeDiscount-295392269811270479_295392271110632861\"]}]},\"sourceParamDTO\":{\"orderFrom\":\"ITEM_DETAIL\",\"platformType\":\"H5\"}}",
    "checkout": true,
    "giftInfo": [],
    "content": {
        "discountOrderPrice": "￥1.62",
        "giftInfo": [],
        "deductionAmountCent": 0,
        "freight": "￥0.00",
        "originalOrderPrice": "￥6.00",
        "isShowDeduction": false,
        "cashCouponAvailableAmount": "0.00",
        "orderItems": [
            {
                "skuTitle": "尺码liu:s;",
                "quantity": 1,
                "itemNo": "437785727578359550",
                "originPrice": "5.00",
                "realTotalPrice": "3.65",
                "itemName": "酷酷酷酷酷",
                "orderLineType": 0,
                "cashCouponDeduct": false,
                "imageUrl": "https://fh01-uat-bucket.oss-cn-beijing.aliyuncs.com/fhmall/feiHeMall/materials/20221115/ebfcb569774350d13b2d908650efaee0.jpg",
                "skuCode": "437785727582553711",
                "status": "VALID",
                "realPrice": "3.65"
            },
            {
                "skuTitle": "hps测试属性项:颜色;hps颜色属性:青;",
                "quantity": 1,
                "itemNo": "441715696818233784",
                "originPrice": "1.00",
                "realTotalPrice": "0.73",
                "itemName": "hps网络分销商品A",
                "orderLineType": 0,
                "cashCouponDeduct": false,
                "imageUrl": "https://fh01-uat-bucket.oss-cn-beijing.aliyuncs.com/fhmall/feiHeMall/materials/20221115/ebfcb569774350d13b2d908650efaee0.jpg",
                "skuCode": "442873961665222247",
                "status": "VALID",
                "realPrice": "0.73"
            }
        ],
        "wareHouse": [
            {
                "storeName": "hps分销自营店",
                "storeId": "2000473782"
            },
            {
                "storeName": "hps分销专卖店",
                "storeId": "2000473784"
            }
        ],
        "canUseCashCoupon": false,
        "outerOrderId": "A05528122F868AEB959ED74192866E11",
        "deductionAmount": "0.00",
        "nonDeductionAmount": "4.38",
        "showCashCoupon": true,
        "orderPrice": "￥4.38",
        "chooseCashCoupon": false,
        "finalOrderPrice": "￥4.38"
    },
    "zeroOrder": false,
    "address": "756435",
    "receiverName": "432423423",
    "phone": "17600260977"
}
```





情况1：

1. 登录sheet页1，账户A

2. 下单前选择渠道店铺 

3. 不选择商品
4. sheet页2，登录用户B
5. 回到sheet页1，选择商品，可以下单，
6. 此时渠道店铺和商品不对应，订单在账户B下



情况2：

1. 登录sheet页1，账户A
1. 下单前选择渠道店铺
1. 选择商品
1. sheet页2，登录用户B
1. 回到sheet页1，无法完成下单，错误信息如下：



![image-20221213101850221](image-20221213101850221.png)



情况3：

1. 登录sheet页1，账户A
2. 下单前选择渠道店铺
3. 选择商品
4. 完成下单
5. 在sheet页2，登录账户B
6. 回到sheet页1，无法完成支付，订单在账户A下，错误信息如下：

![image-20221213102110242](image-20221213102110242.png)

情况4：

1. 登录sheet页1，账户A
2. 下单前选择渠道店铺
3. 选择商品
4. 不下单
5. 在sheet页2，登录账户B
6. 回到sheet页1，无法下单，错误信息如下：

![image-20221213104650560](image-20221213104650560.png)



总结：

选择渠道店铺时，每次点击下拉框没有请求接口。

选择商品时，每次点击选择商品按钮，都触发了请求接口都是最新的商品数据。



# 分销端创建订单

distribution_trade_order_adjust_render （填写收货地址，手机号时触发的接口）

distribution_region_code_search （创建订单时触发）

distribution_trade_order_render  （创建订单时触发）

distribution_cart_cart_query_with_promotion （创建订单时触发）





distribution_trade_order_create （创建订单提交时触发）

distribution_payment_cashier_consult（创建订单提交时触发）

distribution_cart_cart_delete（创建订单提交时触发）



distribution_trade_order_render

```json
{
    "scene": "agent",
    "orderItems": [
        {
            "outerId": "test12345678901",
            "itemNo": "441715696818233784",
            "skuCode": "442873961665222247",
            "quantity": 3
        },
        {
            "outerId": "test12345678901",
            "itemNo": "441715696818233784",
            "skuCode": "441715696818233785",
            "quantity": 1
        }
    ],
    "storeId": "2000473782"
}
```

User 对象

```json
{
    "empId": "CZ_347553214662345423",
    "realName": "韩彭帅q",
    "stageName": "韩彭帅q",
    "email": "820506379@qq.com",
    "extProps": {
        "bizType": "MERCHANT",
        "relatedMerchantBuyerId": "U347550423274010048",
        "belongOrganizationId": "347553214263887398",
        "merchantId": "100331",
        "bizId": "100331",
        "enterpriseId": "347553214263887398"
    }
}
```

[Error: builder.buildValue(assertCondition.errorMessage): 表达式当下所选择的渠道店铺在当前商家登陆账号下不存在编译错误] [Near : {... @foreach{assertCondition : ste ....}] ^ [Line: 1, Column: 1]



![image-20221216172512463](image-20221216172512463.png)



```json

```





```json
{
    "result": {
        "result": {
            "total": 2,
            "totalLong": 2,
            "totalPages": 0,
            "content": [
                {
                    "storeCustomerRegisterLink": "https://mall-uat2.feihe.com?path=1621926823456&merchantId=100331&storeId=2000473782",
                    "shopStatus": 1,
                    "shopStatusDesc": "开店中",
                    "storeId": "2000473782",
                    "storeCode": "100778002",
                    "wareHouse": "hps分销自营店"
                },
                {
                    "storeCustomerRegisterLink": "https://mall-uat2.feihe.com?path=1621926823456&merchantId=100331&storeId=2000473784",
                    "shopStatus": 1,
                    "shopStatusDesc": "开店中",
                    "storeId": "2000473784",
                    "storeCode": "100776003",
                    "wareHouse": "hps分销专卖店"
                }
            ],
            "totalElements": 2
        },
        "success": true,
        "header": {
            "date": "2022-12-14 13:34:18",
            "traceId": "eaac11b53516709960586104967d1048",
            "rpcId": "0.2"
        }
    }
}
```

脚本

```java
Map<String, Object> result = new HashMap<>();

List<Map<String, Object>> contentList = input.get("contentList");

String storeId = input.get("storeId");

String lastFailMessage = null;
// 店铺编码强校验
if (contentList == null){
    lastFailMessage = "未找到商家所属店铺";
    result.put("fail",1);
    result.put("failMsg",lastFailMessage);
    return result;
}
boolean isStoreIdExist = false;
for (int z = 0; z < contentList.size(); z++) {
    Map<String, Object> contentItem = contentList.get(z);
    if (storeId.equals(contentItem.get("storeId"))){
        isStoreIdExist = true;
        break;
    }
}
if (!isStoreIdExist){
    lastFailMessage = "该店铺不属于当前商家";
    result.put("fail",1);
    result.put("failMsg",lastFailMessage);
}
return result;
```

![image-20221216172550752](image-20221216172550752.png)



分销端根据登陆用户查询商家信息

SELECT * FROM cz_employee WHERE phone = '18150965191'

SELECT * FROM cz_organization WHERE id ='200937'

SELECT * FROM cz_merchant WHERE id ='200937'
