纪元：retailforce_oms_pro

excel服务：import_main_order

独立导单新增渠道导入时，需要新增审批流以及审批人。



独立导单，密文导单，关联导单都是提供给业务方使用的。

独立导单：导入一个完整的第三方平台订单。适用于没有进行系统对接，或系统对接出现异常，需要人工手动导入订单到中台系统。

密文导单：和独立导单功能一致，适用于第三方订单履约信息是密文的情况下使用。

联合导单：由业务方对已经存在的订单赠送赠品的场景下使用，将赠品订单信息，关联到已存在的订单上。



com.alibaba.rainbow.core.service.trade.business.OrderImportProcessorService#importOrder 创单接口

com.alibaba.rainbow.core.service.trade.api.impl.OrderImportApiServiceImpl#passOrder 通过接口

com.alibaba.oms.core.service.trade.api.impl.OrderImportFlowPortalServiceImpl#flowCallBack 审批流回调方法

com.alibaba.rainbow.core.service.trade.scheduler.CreateOrderProcessor#process
定时任务 产生订单



导单列表查询

com.alibaba.rainbow.openapi.trade.OrderImportApiService#selectPage







三方订单执行状态的流转：

初次导入的三方订单存在于飞鹤中台数据库，状态为（等待执行），由定时任务定期同步到阿里中台，同步成功更新状态为（执行成功），同步失败更新状态为（执行失败），（无法执行）此状态标志着该订单未获取到支付成功事件，需要联系客服确认。（延迟执行）此状态标志被风控命中且审核中的订单需要延迟处理，需要审核通过后，会由处理延迟执行的三方订单的定时器定期同步阿里中台。



com.alibaba.oms.core.service.trade.api.impl.OrderImportDetailServiceImpl#importMainOrder

com.alibaba.oms.core.service.trade.business.OrderImportDetailBusinessService#importMainOrderList

com.alibaba.oms.core.manager.rpc.trade.OrderImportDetailAbilityManager#batchInsert

com.alibaba.rainbow.openapi.trade.OrderImportDetailApiService#batchInsert

com.alibaba.rainbow.core.service.trade.business.OrderImportDetailService#insertList

com.alibaba.rainbow.core.service.trade.business.OrderImportDetailCheckService#insertList

//列表入库

com.alibaba.rainbow.core.service.trade.business.OrderImportDetailCheckService#insertNew

​    //分页保存导入明细

​	com.alibaba.rainbow.core.dal.trade.dao.OrderImportDetailDAO#insertList

//更新主表状态为库存占用中

com.alibaba.rainbow.core.service.trade.business.OrderImportDetailCheckService#updateImportOrderStatus

//调用渠道库存预占接口

com.alibaba.cloud.retail.business.inventory.abililty.api.interfaces.BusinessInventoryAbilityWriteService#occupy

//更新预占渠道库存成功的数据(1000一组处理)

com.alibaba.rainbow.core.dal.trade.dao.OrderImportDetailDAO#batchUpdateOrderBusinessInventoryStatus

//更新主单信息

com.alibaba.rainbow.core.dal.trade.dao.OrderImportDAO#update









需要添加校验的地方：

com.alibaba.rainbow.core.service.trade.business.OrderImportDetailCheckService#checkStorePass

```java
private boolean checkStorePass(List<OrderImportDetailReq> list) {
        String storeCode = list.get(0).getShopCode() == null ? "" : list.get(0).getShopCode().trim();
        if (StringUtils.isBlank(storeCode)) {
            setFalse(list, "店铺编码不能为空；");
            return false;
        }
        if (storeCode.length() > TradeConstant.SHOP_NO_MAX_LENGTH) {
            setFalse(list, "店铺编码长度不能超过" + TradeConstant.SHOP_NO_MAX_LENGTH + "；");
            return false;
        }
        //查询店铺信息
        StoreAbilityDTO storeAbilityDTO = getStoreMessageByStoreCode(storeCode);
        if (storeAbilityDTO == null) {
            setFalse(list, "店铺编码查询店铺信息失败，店铺编码:" + storeCode + "；");
            return false;
        }
        //不允许导入的店铺类型校验：“营养顾问店铺、自营企业O2O店铺、旗舰店、自营店、专卖店、专营店"不允许导入
        Integer storeType = storeAbilityDTO.getStoreType();
        if (StoreTypeEnum.PERSONAL.getValue().equals(storeType) || StoreTypeEnum.O2O.getValue().equals(storeType) || StoreTypeEnum.TWO_FLAGSHIP.getValue().equals(storeType) || StoreTypeEnum.TWO_SELF_OPERATED.getValue().equals(storeType) || StoreTypeEnum.TWO_MONOPOLY.getValue().equals(storeType) || StoreTypeEnum.TWO_EXCLUSIVE.getValue().equals(storeType)) {
            setFalse(list, "营养顾问店铺、自营企业O2O店铺、旗舰店、自营店、专卖店、专营店不允许导入；");
            return false;
        }
        //检查是否有渠道信息
        ChannelSDO channel = storeAbilityDTO.getChannel();
        if (channel == null || StringUtils.isBlank(channel.getChannelCode())) {
            setFalse(list, "店铺中没有查询到渠道信息，店铺编码：：" + storeCode + "；");
            return false;
        }
        if (StringUtils.isBlank(channel.getChannelName())) {
            //店铺里面的渠道名称只是个快照,没有时重新查下渠道
            ChannelDTO channelDTO = getChannelByCode(channel.getChannelCode());
            if (channelDTO != null) {
                channel.setChannelName(channelDTO.getName());
            }
        }
  
  			//TODO 新增校验 独立导单功能中对于订单渠道为经销、代销订单，需要额外填写授权店铺编码。
  			//店铺编码、授权店铺编码的对应渠道必须一致，否则报错提示“授权店铺所属渠道必须与订单渠道来源相同”
  
  
        //检查是否有平台信息
        PlatformSDO platform = storeAbilityDTO.getPlatform();
        //2、平台类型
        if (platform == null || StringUtils.isBlank(platform.getPlatformCode())) {
            setFalse(list, "店铺中没有查询到平台信息，店铺编码：" + storeCode + "；");
            return false;
        }
        for (OrderImportDetailReq detailReq : list) {
            String storeCodeItem = detailReq.getShopCode() == null ? "" : detailReq.getShopCode().trim();
            detailReq.setShopCode(storeCodeItem);
            if (StringUtils.isBlank(storeCodeItem)) {
                setFalse(list, "店铺编码不能为空；");
                return false;
            }
            if (!storeCode.equals(storeCodeItem)) {
                setFalse(list, "同一批次导入，店铺编码必须一致；");
                return false;
            }
        }
        list.forEach(importDetail -> {
            OrderImportDetailFeatureReq detailFeatureReq = importDetail.getDetailFeatureReq();
            if (detailFeatureReq == null) {
                detailFeatureReq = new OrderImportDetailFeatureReq();
            }
            detailFeatureReq.setChannelCode(channel.getChannelCode());//渠道编码
            detailFeatureReq.setStoreId(storeAbilityDTO.getStoreId());//店铺id
            detailFeatureReq.setOutStoreId(storeAbilityDTO.getOutStoreId());//三方店铺id
            detailFeatureReq.setStoreType(storeType);//店铺类型
            importDetail.setDetailFeatureReq(detailFeatureReq);
            importDetail.setChannelName(channel.getChannelName());
            importDetail.setChannelId(channel.getChannelId());
            importDetail.setPlatformId(platform.getPlatformId());
            importDetail.setPlatformCode(platform.getPlatformCode());//平台编码
        });
        return true;
    }
```









现有校验如下：

1. 店铺编码:一个excel里店铺编码必须同一个（不为同一个时立即返回false）
   1. 店铺编码不能为空；
   2. 店铺编码长度不能超过10；
   3. 店铺编码查询店铺信息失败，店铺编码:<font color="red">XXX</font>；
   4. 营养顾问店铺、自营企业O2O店铺、旗舰店、自营店、专卖店、专营店不允许导入；
   5. 店铺中没有查询到渠道信息，店铺编码：：<font color="red">XXX</font>；
   6. 店铺中没有查询到平台信息，店铺编码：<font color="red">XXX</font>；
   7. 同一批次导入，店铺编码必须一致；
2. 三方单号:验证各条的三方单号
    	1. 三方订单号不能为空；
    	2. 三方订单号长度不允许大于30；

3. 校验仓库编码
4. 赋值抖音加密默认用户
5. 逐条处理逻辑：.....



com.alibaba.rainbow.core.dal.trade.enums.PlatformTypeEnum





独立导单提交审批流程：

* oms平台端调用纪元：retailforce_oms_pro，API：commit_main_file
* 纪元调用oms，RPC： -> com.alibaba.oms.portal.api.trade.OrderImportService#commitFile
* oms调用rainbow，com.alibaba.rainbow.openapi.trade.OrderImportApiService#commitFile

​	rainbow此时 只修改备注，但是不更改 导单列表的草稿状态

* rainbow调用纪元，请求参数：

```json
{
    "meshInterface": "com.alibaba.lattice2.epoch.meshflow.service.MeshFlowService",
    "meshVersion": "1.0.0.UAT",
    "paramMap": {
        "flowCode": "dmEventTrigger",
        "header": {
            "userId": "1000000001"
        },
        "tenantCode": "master_daily",
        "appCode": "epoch_client",
        "body": {
            "eventCode": "startOrderAuditFlow",
            "empId": "1000000001",
            "data": {
                "importNo": "a08cff4b-b908-4372-8fd1-ff092dcc35ab",
                "oaCode": "123499_"
            },
            "modelCode": "ThirdOrderImportModel",
            "appCode": "retailforce_oms_pro"
        },
        "class": "com.alibaba.lattice2.epoch.meshflow.dto.runtime.FlowMessage",
        "metadataType": "api"
    }
}
```

* 调用返回值如下：

```json
{
    "appCode": "epoch_client",
    "tenantCode": "master_daily",
    "body": {
        "result": [],
        "modelCode": "ThirdOrderImportModel",
        "success": true,
        "appCode": "retailforce_oms_pro",
        "tenantCode": "master_daily"
    },
    "flowCode": "dmEventTrigger",
    "success": true,
    "header": {
        "userId": "1000000001"
    },
    "class": "com.alibaba.lattice2.epoch.meshflow.dto.runtime.FlowMessage",
    "metadataType": "api"
}
```







```json
//独立导单存在的问题
//纪元解析Excel问题
{
        "address": "北京市通州区东潞苑小区10号楼1单元603",
        "city": "北京市",
        "deliveryCostStr": "0",
        "district": "通州区",
        "employeeId": "265206049843773708",
        "employeeName": "商薇",
        "itemCount": 150,
        "itemMoneyStr": "N5*10.11515",
        "itemName": "【YL】y飞鹤牧场-7天面",
        "itemSkuId": "480816896793073042",
        "orderImportType": "109",
        "orderType": 0,
        "province": "北京",
        "receiver": "张淑玲",
        "receiverPhone": "15811539264",
        "remark": "营养&牧场面导单",
        "shopCode": "B031",
        "success": true,
        "threePartOrder": "456789097",
        "totalMoneyStr": "10.1*N51515"
    },
    {
        "address": "北京市通州区车站路27号楼441",
        "city": "北京市",
        "deliveryCostStr": "0",
        "district": "通州区",
        "employeeId": "265206049843773708",
        "employeeName": "商薇",
        "itemCount": 150,
        "itemMoneyStr": "1515",
        "itemName": "【YL】y飞鹤牧场-7天面",
        "itemSkuId": "480816896793073042",
        "orderImportType": "109",
        "orderType": 0,
        "province": "北京",
        "receiver": "王霞",
        "receiverPhone": "18510267516",
        "remark": "营养&牧场面导单",
        "shopCode": "B031",
        "success": true,
        "threePartOrder": "456789098",
        "totalMoneyStr": "1515"
    }
```



